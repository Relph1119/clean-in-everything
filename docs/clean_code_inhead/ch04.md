# 第四部分 由快到稳的实现

## 第10章 新增代码

- 功能标识：把功能本身和其实现代码分隔开，把功能隐藏在功能标识之后。使用配置把功能隐藏起来。
- 绞杀榕模式：**对于任何重大变化，不要在原地进行，而要平行推进。**
  - 在方法层面上，首先添加新方法，再逐渐将调用者转移过来，最后删除旧的方法。
  - 在类层面上，首先添加新类，再逐渐将调用者转移过来，最后删除旧的类。
- 版本管理：
  - *务必保持向后兼容性*
  - 如果必须破坏兼容性，请考虑是否可以将多个破坏性变更打包在一个版本中。

## 第11章 修改单元测试

- 安全网：测试代码改得越多，你就越难相信它。
- 新增测试或断言是可行的，删除测试或断言则会削弱系统的保证。
- 见证测试失败：
  - 如果必须同时更改测试代码和生产代码，不妨考虑先故意让测试失败。
  - 如果一个测试从来没有失败过，它就不值得信任。
- 总结：
  - 改动单元测试代码要小心，因为没有安全网可以依赖。
  - 添加新测试、新断言或新测试用例往往是安全的。
  - 测试代码和生产代码一样重要，有时候应该重构测试代码，以优化其内部结构。

## 第12章 故障排除

- 科学方法：
  - 做出预测（假设）。
  - 做实验。（单元测试可以被视为典型的实验）
  - 将结果与预测进行比较，如此反复，直到明白发生了什么。
- 橡皮鸭法：*拨出25分钟来研究某个问题，如果时间到了还没有任何进展，就休息一下。*
- 慢速测试：创建第二个项目，包含生产代码、单元测试代码以及涉及数据库的集成测试。每个测试用例的行为包括新建一个数据库，在上面运行所有DDL脚本，运行测试，销毁此数据库。
- 二分法：
  1. 找到一种办法类检测或重现问题。
  2. 删除一半代码。
  3. 如果问题仍然存在，那么从第2步开始重复。如果问题消失了，那么恢复之前删除的代码，并删除另一半，同样从第2步开始重复。
  4. 继续，直到你把产生问题的代码规模缩减到自己能理解发生了什么为止。
- 总结：*排除故障在相当程度上依赖于个人经验，将科学方法、自动化测试和二分法的结合更有效率。*

## 第13章 关注点分离

- 组合：面向对象的组合的关注点往往在于将副作用组合起来。
- 引用透明性：体现在纯函数上。
  - 纯函数非常容易组合。
  - 对纯函数的调用原地替换为其结果。
  - 引用透明的函数将各种复杂性归约为单一对象。
  - 函数式核心、命令式外壳：把非确定性的查询和有副作用的行为限制在系统外围，以纯函数的形式实现复杂逻辑。
- 日志功能：
  - 性能监控：将性能测量结果写入性能日志。
  - 审计：将审计数据写入审计日志。
  - 计费：将使用数据写入最终成为发票的内容。
  - 仪表化：将调试信息写入日志。
- 日志的主要目的：记录所有“不纯”的动作，记录所有无法重现的东西，包括所有非确定性的代码。
