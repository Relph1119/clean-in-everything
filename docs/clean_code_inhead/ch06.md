# 餐馆预订系统的逐步构建与优化

## 1 针对新代码库的checklist

- 创建Restaurant项目，使用Git，先做一次空提交
- 自动化构建：由`Visual Studio`生成默认的`ASP.NET Core Web Service`入口和`Startup`文件。
- 编写构建脚本：
```shell
#！/usr/bin/env bash
dotnet build --configuration Release
```
- 显示所有错误信息，将警告当成错误，并修复代码中的警告。

## 2 构建活动骨架

- 使用测试驱动开发（`TDD`）。
- 特征测试：对HTTP主页（`home`）资源的集成测试。
- AAA模式：用更宽松的代码分析规则测试，使用`Justification`作为正式理由。

## 3 创建一套贯穿系统的垂直切片

- 目的：将接收有效的预订请求，保存在数据库中。
- 测试方法：编写一套针对HTTP边界的自动化测试（验收测试驱动开发）
  - 主页的数据格式测试：针对主页（`home`）资源会返回JSON格式数据的测试。
  - 提交预订请求的功能测试：预订请求包括有效的日期、电子邮件、姓名和预订座位数。
- 构建单元测试方法：发布有效预订的单元测试`ReservationsTests.cs`。
- 构建DTO和领域模型：
  - `ReserationDto`类：用来封装预订的业务规则，主要功能是作为数据传输对象。
  - `Reservation`类：真正的业务实体类。
  - `FakeDatabase`类：Fake数据库。
  - `IReservationsRepository`接口：数据保存接口。
  - `ReservationsController`类：实现数据的增删改查功能。
- 配置依赖关系：实现临时的、嵌套的私有类`NullRepository`，用`ASP.NET`的内置`DI`容器注册`NullRepository`。
- 初始化数据库：创建`schema`，使用`SQL Server`初始化数据库。
- 基于`SQL Server`实现的`SqlReservationsRepository`类。
- 实现链接数据库的配置。
- 冒烟测试：使用`Fake`数据库进行边界测试。

## 4 保存数据

- 将已有测试改成参数化测试：使用`[Theory]`属性来表示参数化测试。
- 功能验证：
  - 错误的日期问题：对传入的日期进行判空保护
  - 无效预订座位数问题：对传入的座位数进行小于1的判断保护。

## 5 解决超订问题

- 系统功能：应该根据已有的预订记录和餐厅容量来检查预订请求。
- 测试代码：第1次预订6个座位，第2次预订5个座位，该结果应该是失败的。
- 修改代码：先查询已有的预订记录（累加），再把加上当前预订请求的座位数，如果超过餐厅容量，就返回错误。

## 6 分解代码

- 目标：降低Post方法的圈复杂度。
- 解决方法：提取辅助方法`IsVaild`，判断传入dto的检查规则。
- 效果：将代码行数减少到22，圈复杂度降低至5。

## 7 API设计

- 目标：控制餐厅的预订和分配餐桌。
- 解决方法：使用`MaitreD`领班类，实现`WillAccept`方法接收预订和分配餐桌功能
- 效果：降低维护成本，如果更改了`MaitreD`的构造函数，只需在创建要注入的`MaitreD`对象的地方更改即可。

## 8 新增功能

- 日历标识：
  - 功能：让客户浏览某月或某天的预订情况，查看当时还有多少空座位。用户界面上可以基于它的数据来显示具体某天是否有额外预订开放。
  - 实现情况：无法在4个小时之内完成该功能。
  - 解决方法：使用`enableCalendar`隐藏日历链接。
  - 测试方法：在自动化集成测试中，开启这个功能。
- 绞杀榕模式：
  - 使用一个新方法取代旧的`ReadReservations`方法，实现具体某天的预订情况查询。
  - 使用`TimeSlot`对象迁移调用者，删除`Occurrence<T>`类。

## 9 修改单元测试

- 对`PostInvalidReservation`增加参数化测试方法，不影响已有测试。 
- 测试目标：对系统在正确场景下发送电子邮件的行为进行单元测试
- 测试方法：
  - 实现`SpyPostOffice`类，模拟发送一份电子邮件。
  - 嵌套一个`Observation`类，同时跟踪交互类型和预订记录。

## 10 实现横切面关注点

- 创建日志的装饰器`LoggingReservationsRepository`类声明和构造函数。
- 用`ASP.NET`框架配置一个装饰器。

## 11 安全加固

- 使用`FsCheck`库对基于属性的测试方法进行改造。
